"use strict";angular.module("Requests").controller("CreateFormController",["$scope","api","ClrStatusSrv","globalVarsSrv","$routeParams","AuthenticationService","MakeModal","$location",function(e,t,o,s,i,r,a,l){function m(){e.maxLoaders===e.finishedLoaders&&e.init()}function n(t){if(!e.item.fromd||""===e.item.fromd)return a.generalInfoModal("sm","info","","Παρακαλώ συμπληρώστε ημερομηνίες.",1),!1;if("a"===t){if(0===e.item.date_index.length)return a.generalInfoModal("sm","info","","Παρακαλώ επιλέξτε ημέρες.",1),!1;if(!e.selectedUse.selected)return a.generalInfoModal("sm","info","","Παρακαλώ επιλέξτε χρήση αίθουσας.",1),!1;if(0===e.selectedRooms.length)return a.generalInfoModal("sm","info","","Παρακαλώ επιλέξτε αίθουσες.",1),!1}if("r"===t){if(0===e.item.date_index.length)return a.generalInfoModal("sm","info","","Παρακαλώ επιλέξτε ημέρες.",1),!1;if(0===e.selectedRooms.length)return a.generalInfoModal("sm","info","","Παρακαλώ επιλέξτε αίθουσες.",1),!1}return!0}e.tmpDate=new Date,e.views=[],e.currentPage=0,e.book=[],e.rooms=[],e.weekOptions=s.getGlobalVar("weekdaysTableDateIndex"),e.user=s.getGlobalVar("auth"),e.teachers=[],e.itemtype=[],e.allTeachers=[],e.psTeachers=[],e.bookingErrors=[],e.selectedPeriod={},e.selectedRooms=[],e.personalTms=[],e.tms=[],e.filtertms=[],e.courses=[],e.selectedCourse={},e.coursesDp=[],e.roomDP=[],e.selectedUse={selected:!1},e.calendarSelectedDay=null,e.fromAnotherPage=!1,e.createFormControllerNotV=!0,e.roomscategory=[],e.selectedDays=[{d:"Κυριακή",i:0,s:!1},{d:"Δευτέρα",i:1,s:!1},{d:"Τρίτη",i:2,s:!1},{d:"Τετάρτη",i:3,s:!1},{d:"Πέμπτη",i:4,s:!1},{d:"Παρασκευή",i:5,s:!1},{d:"Σάββατο",i:6,s:!1}],e.mode="inserting",e.maxLoaders=4,e.finishedLoaders=0,e.screenState="normal",e.toRefresh={},e.coursesDp=[],r.CheckCredentials(),e.config=[],e.periodActive=!0,t.apiCall("GET","api/public/config",function(t){e.config=t.data}),e.simpleManager=!0;for(var c=0;c<e.user.authdata.roles[0].roles.length;c++)19===e.user.authdata.roles[0].roles[c].id&&(e.simpleManager=!1);e.reload=function(){s.setGlobalVar("cur",!0),location.reload(),l.path("/usercreaterequests")},e.init=function(){i.id?t.apiCall("GET","api/public/requests/"+i.id,function(o){e.screenState="edit",e.item=o.data,e.item.active=!0,e.selectedPeriod=e.item.periods,e.item.fromd=new Date(e.item.fromd+" 00:00:00"),e.item.tod=new Date(e.item.tod+" 00:00:00"),e.item.status="14".indexOf(e.item.status)>=0?0:e.item.status,e.item.guests||(e.item.guests=[]);for(var s=0;s<e.item.rooms.length;s++){var r=e.item.rooms[s];e.item.rooms[s].pivot.fromt=new Date("1970-01-01 "+e.item.rooms[s].pivot.fromt),e.item.rooms[s].pivot.tot=new Date("1970-01-01 "+e.item.rooms[s].pivot.tot),delete e.item.rooms[s].pivot.id,r=Object.assign(r,e.item.rooms[s].pivot),e.selectedRooms.push(r);for(var a=0;a<e.rooms.length;a++)e.item.rooms[s].id===e.rooms[a].id&&(e.rooms[a].checked=!0);e.item.rooms[s]=Object.assign(e.item.rooms[s],e.item.rooms[s].pivot)}for(var l=0;l<e.roomUse.length;l++)e.roomUse[l].id===e.item.room_use.id&&e.selectUse(e.roomUse[l]);if(e.item.ps)for(var m=0;m<e.courses.length;m++)if(e.courses[m].id===e.item.ps.id){e.selectCourse(e.courses[m]);break}e.coursesDp.push(e.courses[m]),e.item.guests&&t.apiCall("GET","api/public/requests/"+i.id+"/guests",function(t){e.item.guests=t.data}),e.item.date_index="";for(var n=0;n<e.item.rooms.length;n++)for(var c=0;c<e.selectedDays.length;c++)c===e.item.rooms[n].pivot.date_index&&(e.selectedDays[c].s=!0,e.item.date_index+=c+"");e.getBook(e.item)}):(e.selectedPeriod={},e.selectedRooms=[],e.selectedCourse={},e.selectedUse={},e.currentPage=0,e.item={status:0,rooms:[],date_index:"",guests:[],ps_id:null,class_use:null,tm_id:null})},e.steps=[{text:"Επιλογή Χρήσης / Περιόδου",active:!0},{text:"Επιλογή Μαθήματος",active:!0},{text:"Επιλογή Αίθουσας",active:!0},{text:"Ορισμός Παρευρισκομένων",active:!1},{text:"Ελεγχος Διαθεσιμότητας",active:!0}],t.apiCall("GET","api/public/personal/"+e.user.authdata.roles[0].id+"/rooms",function(t){e.personalRooms=t.data}),e.personalTms=e.user.authdata.roles[0].tm,"admin"===s.getGlobalVar("menuRole")&&t.apiCall("GET","api/public/tms",function(t){e.personalTms=t.data}),e.filterRooms=function(t,o,s){for(;e.roomDP.length>0;)e.roomDP.pop();for(var i=0,r=0;r<e.itemtype.length;r++)e.itemtype[r].visible&&i++;o.map(function(t){for(var o=!1,s=0,r=0;r<t.items.length;r++){for(var a=0;a<e.itemtype.length;a++)t.items[r].id===e.itemtype[a].id&&e.itemtype[a].visible&&s++;s===i&&(o=!0)}!o&&i||e.roomDP.push(t)})},t.apiCall("GET","api/public/roomcategory",function(t){e.roomscategory=t.data}),e.filteringRooms=function(t,o,s){for(e.roomDP=[];e.roomDP.length>0;)e.roomDP.pop();o.map(function(t){var o=!0;o=!(!(!s.room||t.name.indexOf(s.room.toUpperCase())>=0||t.address.indexOf(s.room.toUpperCase())>=0)||!o),(o=!(s.roomcat&&t.capasity_categ!==s.roomcat||!o))&&e.roomDP.push(t)})},t.apiCall("GET","api/public/itemtype",function(o){e.itemsrooms=o.data,e.itemtype=o.data,e.itemtype.map(function(e){e.title=e.descr}),t.apiCall("GET","api/public/rooms",function(t){e.rooms=e.personalRooms&&e.personalRooms.length>0?e.personalRooms:t.data;for(var o=0;o<e.rooms.length;o++)e.rooms[o].checked=!1;e.tileRooms=e.rooms,e.filterRooms(e.roomDP,e.tileRooms,e.roomsFilter),e.finishedLoaders++,m()})}),t.apiCall("GET","api/public/roomuse",function(t){e.roomUse=t.data,e.finishedLoaders++,m(),e.roomUse.map(function(t){t.useVisibility=!0;for(var o=0;o<e.user.authdata.roles[0].roles.length;o++)"Αργ"===t.synt&&(t.useVisibility=!1),19===e.user.authdata.roles[0].roles[o].id&&"4912".indexOf(t.id)>=0&&(t.useVisibility=!1)})}),e.$watch("selectedConfig",function(t,o){t&&e.getCourses(t)}),e.getCourses=function(o){e.courses=[],e.tms=[],"admin"===s.getGlobalVar("menuRole")?(t.apiCall("GET","api/public/ps/conf/"+e.selectedConfig,function(t){e.courses=t.data}),t.apiCall("GET","api/public/tms",function(t){var o=[];t.data.map(function(e){o.indexOf(e.descr)<0&&o.push(e.descr)}),e.tms=o})):t.apiCall("POST","api/public/user/tms",function(o){e.tms=o.data,e.tms.map(function(o){t.apiCall("GET","api/public/ps/conf/"+e.selectedConfig,function(t){for(var s=0;s<t.data.length;s++)t.data[s].tm_code===o.id&&e.courses.push(t.data[s])})})},void 0,e.user.authdata.roles[0].tm),e.finishedLoaders++,m()},e.teachersPushed=[],t.apiCall("GET","api/public/users",function(t){for(var o=0;o<t.data.length;o++)7===t.data[o].cat_id&&(e.allTeachers[t.data[o].id]=t.data[o],e.teachersPushed.push(t.data[o]));e.finishedLoaders++,e.teachers=e.teachersPushed,m()}),e.newUserRequest=function(){if(i.id)l.path("/usercreaterequests");else{s.setGlobalVar("cur",!0),e.selectedRooms=[],e.selectedCourse.selected=!1,e.selectedCourse={},e.book=[];for(var t=0;t<e.rooms.length;t++)e.rooms[t].checked=!1}},e.postUserRequest=function(o){o.conf_id=e.selectedConfig,o.status=o.status?o.status:0,o.user_id=e.user.authdata.roles[0].id,o.req_dt=new Date,o.pivot=[],o.ps_id=e.selectedCourse.id&&e.selectedCourse.selected?e.selectedCourse.id:null,o.class_use=e.selectedUse.id,o.priority=e.selectedUse.priority,o.descr=o.descr?o.descr:"",null===o.tm_id&&("admin"===s.getGlobalVar("menuRole")?o.tm_id=e.user.authdata.roles[0].tm[0].id:e.personalTms.map(function(e){e.default_tm_sel&&(o.tm_id=e.id)})),o.period=o.period?o.period:-1,o.rooms.map(function(e){var t={comment:e.comment?e.comment:null,date_index:e.date_index,fromt:e.fromt.getMinutes()<10?e.fromt.getHours()+":0"+e.fromt.getMinutes()+":00":e.fromt.getHours()+":"+e.fromt.getMinutes()+":00",teacher:e.teacher?e.teacher:null,tot:e.tot.getMinutes()<10?e.tot.getHours()+":0"+e.tot.getMinutes()+":00":e.tot.getHours()+":"+e.tot.getMinutes()+":00"};o.pivot.push(t)});var r=i.id?"PUT":"POST";"00:00:00"!==o.fromd.toLocaleTimeString("en-GB")&&o.fromd.setHours(0,0,0,0),"00:00:00"===o.fromd.toLocaleTimeString("en-GB")&&(o.fromd=new Date(o.fromd.getTime()-1e3*o.fromd.getTimezoneOffset()*60),o.tod=new Date(o.tod.getTime()-1e3*o.tod.getTimezoneOffset()*60)),t.apiCall(r,"api/public/requests/userrequest",function(e){a.generalInfoModal("sm","info","","Το αίτημά σας καταχωρήθηκε με επιτυχία.",1)},void 0,o)},e.getTeacher=function(t){for(var o=0;o<e.teachers.length;o++)if(e.teachers[o].id===t)return e.teachers[o].user},e.selectCourse=function(o){o.selected?(e.item.tm_id=null,e.item.ps_id=null,e.item.ps=null,e.selectedCourse.selected=!1,e.teachers=e.teachersPushed):(e.selectedCourse.selected=!1,o.selected=!0,e.selectedCourse=o,t.apiCall("GET","api/public/ps/"+e.selectedCourse.id+"/teacher",function(t){e.teachers=t.data.users;for(var o=0;o<e.selectedRooms.length;o++)e.selectedRooms[o].teacher=e.teachers[0].id}),e.item.tm_id=o.tm_code,e.item.ps_id=o.ps_id,e.item.ps=o)},e.selectUse=function(t){t.useVisibility=!0,e.selectedUse.selected=!1,t.selected=!0,e.selectedUse=t,e.item.class_use=t.id,e.steps[3].active=!1,"ΤΗΛ"===e.selectedUse.synt&&(e.steps[3].active=!0)},e.newGuest=function(){var t={req_id:"",name:"",uni:"",email:"",phone:"",comment:""};e.item.guests.push(t)},e.deleteGuest=function(o){t.apiCall("DELETE","api/public/requests/guests/"+o.id,function(t){e.item.guests.splice(e.item.guests.indexOf(o),1)})},e.postGuest=function(o){o.req_id=e.item.id,t.apiCall("POST","api/public/request/guest",function(t){e.item.guests=t.data},void 0,o)},e.roomChecked=function(t){if(t.checked=!t.checked,t.checked)t.fromt||(t.fromt=(new Date).setTime(0),t.tot=(new Date).setTime(0));else for(var o=e.selectedRooms.length-1;o>=0;o--)e.selectedRooms[o].id===t.id&&(e.item.rooms.splice(e.item.rooms.indexOf(e.selectedRooms[o]),1),e.selectedRooms.splice(o,1))},e.mustRefresh=!1,e.$watch("mustRefresh",function(t){t&&(e.mustRefresh=!1,e.getBook(e.item))}),e.dayChecked=function(t){t.s=!t.s,e.item.date_index="",e.selectedDays.map(function(t){t.s&&(e.item.date_index+=t.i)})},e.getBook=function(o){"undefined"===s.getGlobalVar("cur")&&s.setGlobalVar("cur",!0),e.item&&!1===s.getGlobalVar("cur")&&!0===e.checkBookIsClicked&&(e.checkBookIsClicked=!1),t.apiCall("POST","api/public/roombook/dates",function(t){e.book=t.data},void 0,o)},e.checkBookIsClicked=!1,e.showMyBook=function(){n("a")&&(e.checkBookIsClicked=!0,e.book=[],e.getBook(e.item))};var d=0;e.adminConfiguration=function(){for(var t=0;t<e.user.authdata.roles[0].roles.length;t++)if(4===e.user.authdata.roles[0].roles[t].id)return d++,!1;if(0===d)return!0},e.$watch("item.fromd",function(e,t,o){if(o.item&&o.item.fromd){var s=o.item.fromd.getDay();o.selectedDays[s].s||o.dayChecked(o.selectedDays[s]),o.item.tod=o.item.tod?o.item.tod:new Date(o.item.fromd.getTime()+864e5),o.item.tod&&o.item.fromd>=o.item.tod&&(o.item.tod=new Date(o.item.fromd.getTime()+864e5))}}),e.$watch("item.tod",function(e,t,o){if(o.item&&o.item.tod){o.item.fromd&&o.item.fromd>=o.item.tod&&(o.item.tod=new Date(o.item.fromd.getTime()+864e5));var s=o.item.fromd.getDay();o.selectedDays[s].s||o.dayChecked(o.selectedDays[s])}}),e.$watch("selectedPeriod",function(t,o,s){if(t&&t.fromd){if("edit"===s.screenState)return s.screenState="normal",void(s.item.period=t.id);if(s.item.fromd=new Date(t.fromd),s.item.tod=new Date(t.tod),s.item.tod=new Date(s.item.tod.getTime()+864e5),s.item.period=t.id,e.selectedDays.map(function(t){t.s=!1,e.item.date_index=""}),s.item&&s.item.fromd){var i=s.item.fromd.getDay();s.selectedDays[i].s||s.dayChecked(s.selectedDays[i])}}}),e.defaultCourseSelection=null,e.courseFilterObj={tm:null,km:null,ex:null,pm:null,gen:null},e.filterCourses=function(t,o,s){e.coursesDp=[],o.map(function(t){var o=!0;o=!s.tm||t.tm_code===s.tm,o=!(s.psex&&!(s.psex.indexOf(t.ps_ex)>=0)||!o),o=!(s.pskm&&!(s.pskm.indexOf(t.ps_km)>=0)||!o),o=!(s.pm&&!(s.pm.indexOf(t.pm)>=0)||!o),o=!(s.tma&&!(t.tma_code.indexOf(s.tma)>=0)||!o),(o=!!t.selected||o)&&e.coursesDp.push(t)})}}]).controller("RoomSelectController",["$scope","api","MakeModal",function(e,t,o){e.defaultRoomSelection={fromt:null,tot:null,comment:null,teacher:null},e.filterObj={tm:null,km:null,ex:null,pm:null,gen:null},e.itemsrooms=[],e.roomsFilter={room:null,item:null,roomcat:null},e.removeSelectedRoom=function(t){e.item.rooms.splice(e.item.rooms.indexOf(t),1),e.selectedRooms.splice(e.selectedRooms.indexOf(t),1)},e.roomItemsModal=function(){o.generalModal("modules/mainComponents/views/generalModal.html","sm","info","Επιλογή εξοπλισμού",e.itemtype,2,function(t){e.itemtype=t,e.filterRooms(e.roomDP,e.rooms,t)})},e.copyDefaultRoom=function(){e.defaultRoomSelection&&(e.defaultRoomSelection.fromt=0!==e.defaultRoomSelection.fromt?e.defaultRoomSelection.fromt:new Date("1970-01-01T07:58:00"),e.defaultRoomSelection.tot=0!==e.defaultRoomSelection.tot?e.defaultRoomSelection.tot:new Date("1970-01-01T07:59:00"),e.selectedRooms.map(function(t){t.fromt=0===t.fromt?e.defaultRoomSelection.fromt:t.fromt,t.tot=0===t.tot?e.defaultRoomSelection.tot:t.tot,t.comment=t.comment?t.comment:e.defaultRoomSelection.comment,t.teacher=t.teacher?t.teacher:e.defaultRoomSelection.teacher}))},e.roomDaySelect=function(t,o){e.defaultRoomSelection||(e.defaultRoomSelection=Object.assign({},t),e.defaultRoomSelection.date_index=o.i);var s=Object.assign({},t);s.date_index=o.i,e.selectedRooms.push(s),e.item.rooms.push(s)}}]).directive("userRequestHeader",function(){return{restrict:"EA",templateUrl:"modules/requests/createUserRequest/urHeader.html"}}).directive("courseSelect",function(){return{restrict:"EA",templateUrl:"modules/requests/createUserRequest/courseSelect.html"}}).directive("roomSelect",function(){return{restrict:"EA",controller:"RoomSelectController",templateUrl:"modules/requests/createUserRequest/roomSelect.html"}}).directive("bookCheck",function(){return{restrict:"EA",templateUrl:"modules/requests/createUserRequest/bookCheck.html"}}).directive("roomTile",function(){return{restrict:"EA",templateUrl:"modules/requests/createUserRequest/roomTile.html"}}).directive("selectedRoomTile",function(){return{restrict:"EA",templateUrl:"modules/requests/createUserRequest/selectedRoomTile.html"}}).directive("defaultRoomTile",function(){return{restrict:"EA",templateUrl:"modules/requests/createUserRequest/defaultRoomTile.html"}}).directive("daySelect",function(){return{restrict:"EA",templateUrl:"modules/requests/createUserRequest/daySelect.html"}}).directive("useSelect",function(){return{restrict:"EA",templateUrl:"modules/requests/createUserRequest/useSelect.html"}}).directive("reqNavigation",function(){return{restrict:"EA",templateUrl:"modules/requests/createUserRequest/reqNavigation.html"}}).directive("selectGuest",function(){return{restrict:"EA",templateUrl:"modules/requests/createUserRequest/selectGuest.html"}});