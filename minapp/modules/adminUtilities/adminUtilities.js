"use strict";angular.module("Requests").controller("UtilitiesController",["$scope","api","ClrStatusSrv","globalVarsSrv","$routeParams","AuthenticationService","MakeModal","$location",function(e,i,t,o,d,n,s,a){e.selections={from:"1",to:"1"},e.periodSelections={from:{},to:{},s:!1},n.CheckCredentials(),e.yearByYearSelect=function(i){for(var t="",o=0;o<e.futureConfigs.length;o++)e.futureConfigs[o].id==i&&(t=e.futureConfigs[o].year);for(o=0;o<e.futureConfigs.length;o++)if(e.futureConfigs[o].year==t+1)return e.futureConfigs[o].id},e.periodActive=!1,e.copyperiod=[],e.pendings=[],e.statusOptions=o.getGlobalVar("requestStatus"),e.showExpired=!0,e.pastConfigs=[],e.futureConfigs=[],e.selections.to=e.yearByYearSelect(e.selections.from),i.apiCall("GET","api/public/config",function(i){e.pastConfigs=i.data,e.futureConfigs=i.data}),e.$watch("selections.from",function(i,t){e.showMeError=!1,e.periodSelections.s=!1,e.selections.to=e.yearByYearSelect(i)}),"/utilities"==a.$$url?e.utilities=!0:"/checkpending"==a.$$url&&(e.utilities=!1),e.copyAllPeriod=function(t,o){var d=new Date(t.fromd).getTime(),n=new Date(o.fromd).getTime();o.fromd,o.tod;t.synt===o.synt&&t.id!==o.id&&d<n?i.apiCall("POST","api/public/roombook/copyperiod",function(i){e.copyperiod=i.data,s.generalInfoModal("sm","Info","info","Eπιτυχής Αντιγραφή",1)},void 0,{fromP:t,toP:o}):s.generalInfoModal("sm","Info","info","Ανεπιτυχής αντιγραφή (Η επιλογή των εξαμήνων είναι λάθος)",1)},e.filterExpired=function(i){return!e.showExpired||"+"===i.if_expired},e.getExpiredRequests=function(){i.apiCall("GET","api/public/config/1",function(t){e.selectconfig=t.data,i.apiCall("POST","api/public/checkpending",function(i){e.pendings=i.data},void 0,{config:e.selectconfig})})},e.deleteExpiredRequest=function(t){i.apiCall("DELETE","api/public/requests/"+t.id,function(i){e.pendings.splice(e.pendings.indexOf(t),1)})},e.deleteAllExpiredRequests=function(){i.apiCall("PUT","api/public/checkpending/expired",function(e){},void 0,{config:e.selectconfig})},e.selectedPeriod=[],e.selectedDays=[{d:"Κυριακή",i:0,s:!1},{d:"Δευτέρα",i:1,s:!1},{d:"Τρίτη",i:2,s:!1},{d:"Τετάρτη",i:3,s:!1},{d:"Πέμπτη",i:4,s:!1},{d:"Παρασκευή",i:5,s:!1},{d:"Σάββατο",i:6,s:!1}],e.fromd="",e.tod="",e.fromAnotherPage=!0;var l=o.getGlobalVar("auth");e.item={},e.holReq={},e.config={},e.selectedConfig={},e.$watch("selectedPeriod",function(i){e.selectedPeriod&&"/holidayhold"==a.$$url&&(e.item.fromd=e.selectedPeriod.fromd,e.item.tod=e.selectedPeriod.tod)}),e.selectedUse={},i.apiCall("GET","api/public/roomuse/13",function(i){e.selectedUse=i.data}),e.setHoliday=function(t){var o=0,d=0;if(o=Math.abs(t.tod.getTime()-t.fromd.getTime()),d=t.fromd.getDay(),t.fromd=e.item.fromd.getFullYear()+"-"+("0"+(e.item.fromd.getMonth()+1)).slice(-2)+"-"+("0"+e.item.fromd.getDate()).slice(-2),t.tod=e.item.tod.getFullYear()+"-"+("0"+(e.item.tod.getMonth()+1)).slice(-2)+"-"+("0"+e.item.tod.getDate()).slice(-2),(o=Math.ceil(o/864e5))<7)for(var n=0;n<o;n++)t.date_index=d+n;else t.date_index="0123456";t.user_id=l.authdata.roles[0].id,t.descr=e.selectedUse.descr,t.period=null,t.ps_id=null,t.class_use=e.selectedUse.id,t.links=null,t.protocol_id=null,t.status=1,t.admin=l.authdata.roles[0].id,t.conf_id=e.selectedConfig,t.tm_id=l.authdata.roles[0].tm[0].id,t.priority=e.selectedUse.priority,t.pivot=[],i.apiCall("GET","api/public/rooms",function(o){o.data.map(function(e){var i={room_id:e.id,comment:"Αργία",date_index:"0",fromt:"07:00:00",teacher:null,tot:"23:59:59",status:1};t.pivot.push(i)}),i.apiCall("POST","api/public/holiday",function(i){e.holReq=i.data,s.generalInfoModal("sm","Info","Info","Δημιουργήθηκε νέα αργία.",1)},void 0,t)})},e.dayChecked=function(i){i.s=!i.s,e.item.date_index="",e.selectedDays.map(function(i){i.s&&(e.item.date_index+=i.i)})},e.selectAllDays=function(){e.item.date_index="",e.dayState=!e.dayState,e.selectedDays.map(function(i){i.s=e.dayState,e.item.date_index+=i.i})},e.setPeriod=function(i){!0===e.periodsActive?0!==i.status&&(e.selectedPeriod.s=!1,i.s=!0,e.selectedPeriod=i):(e.selectedPeriod.s=!1,i.s=!0,e.selectedPeriod=i)},i.apiCall("GET","api/public/config",function(i){e.config=i.data}),e.ckeckit=function(i){e.justchecking=o.checkDates(i.fromd,i.tod),console.log(e.justchecking)}}]);