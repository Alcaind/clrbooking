"use strict";angular.module("RoomBook",["MainComponents","ui.bootstrap","ApiModules","Authentication","GlobalVarsSrvs"]).controller("BookController",["$scope","api","ClrStatusSrv","globalVarsSrv","$routeParams","AuthenticationService","MakeModal","$location",function(e,t,o,i,s,r,a,n){function m(t){if(!e.item.fromd||""===e.item.fromd)return a.generalInfoModal("sm","Πληροφορία","","Παρακαλώ συμπληρώστε ημερομηνίες.",1),!1;if("r"===t){if(0===e.item.date_index.length)return a.generalInfoModal("sm","Πληροφορία","","Παρακαλώ επιλέξτε ημέρες.",1),!1;if(0===e.selectedRooms.length)return a.generalInfoModal("sm","Πληροφορία","","Παρακαλώ επιλέξτε αίθουσες.",1),!1}return!!("c"!==t||e.item.ps&&0!==e.item.ps.length)||(a.generalInfoModal("sm","Πληροφορία","","Παρακαλώ επιλέξτε μάθημα.",1),!1)}e.periods=[],e.tmpDate=new Date,e.views=[],e.currentPage=0,e.book=[],e.rooms=[],e.weekOptions=o.getStatus("weekdaysTableDateIndex"),e.user=i.getGlobalVar("auth"),e.allTeachers=[],e.courses=[],e.teachers=[],e.bookingErrors=[],e.selectedPeriod={},e.selectedRooms=[],e.selectedCourse={},e.selectedUse={},e.calendarSelectedDay=null,e.periodActive=!1,e.steps=[{text:"Επιλογή Μαθήματος",active:!0},{text:"Επιλογή Αίθουσας",active:!0},{text:"Έλεγχος",active:!0}],e.selectedDays=[{d:"Κυριακή",i:0,s:!1},{d:"Δευτέρα",i:1,s:!1},{d:"Τρίτη",i:2,s:!1},{d:"Τετάρτη",i:3,s:!1},{d:"Πέμπτη",i:4,s:!1},{d:"Παρασκευή",i:5,s:!1},{d:"Σάββατο",i:6,s:!1}],e.mode="reporting",e.coursesDp=[],e.roomDP=[],e.roomscategory=[],e.dayState=!1,e.config=[],t.apiCall("GET","api/public/config",function(t){e.config=t.data});var c=0;if(e.adminConfiguration=function(){for(var t=0;t<e.user.authdata.roles[0].roles.length;t++)if(4===e.user.authdata.roles[0].roles[t].id)return c++,!1;if(0===c)return!0},e.user){r.CheckCredentials();for(var l=0;l<e.user.authdata.roles[0].roles.length;l++){if(4===e.user.authdata.roles[0].roles[l].id){o.getStatus("homeButtonAdminTableConf");break}o.getStatus("homeButtonUserTableConf")}}else e.user||o.getStatus("publicUserTableConf");e.selectAllDays=function(){e.item.date_index="",e.dayState=!e.dayState,e.selectedDays.map(function(t){t.s=e.dayState,e.item.date_index+=t.i})},e.dayChecked=function(t){t.s=!t.s,e.item.date_index="",e.selectedDays.map(function(t){t.s&&(e.item.date_index+=t.i)})},e.openRoomCalendar=function(){e.toRefresh=e.openRoomCalendar,e.book=[],e.rooms.map(function(t){e.selectedDays.map(function(o){if(t.checked&&o.s){var i=Object.assign({},t);i.date_index=o.i,e.selectedRooms.push(i)}})}),e.selectedRooms.map(function(t){t.checked&&(e.item.rooms.includes(t.id)||e.item.rooms.push(t.id))}),m("r")&&(e.deselectAllCourse(),t.apiCall("POST","api/public/roombook/view/by/room",function(t){e.book=t.data,e.item.active=!0,e.gotoPage(2,e.item)},void 0,e.item))},e.mustRefresh=!1,e.toRefresh={},e.$watch("mustRefresh",function(t){t&&(e.mustRefresh=!1,e.toRefresh())}),e.openCourseCalendar=function(){e.toRefresh=e.openCourseCalendar,e.courses.map(function(t){t.selected&&(e.item.ps.includes(t.id)||e.item.ps.push(t.id))}),e.item.date_index="";var o=!1;e.selectedDays.map(function(t){t.s&&(o=!0,e.item.date_index+=t.i+"")}),o||e.selectedDays.map(function(t){t.s=!0,e.item.date_index+=t.i+""}),m("c")&&(e.deselectAllRoom(),t.apiCall("POST","api/public/roombook/view/by/course",function(t){e.book=t.data,e.item.active=!0,e.gotoPage(2,e.item)},void 0,e.item))},e.reload=function(){location.reload()},e.init=function(){e.book=[],s.id?t.apiCall("GET","api/public/requests/"+s.id,function(t){e.item=t.data,e.selectedPeriod=e.item.periods;for(var o=0;o<e.item.rooms.length;o++){var i=Object.assign({},e.item.rooms[o]);e.item.rooms[o].pivot.fromt=new Date("1970-01-01T"+e.item.rooms[o].pivot.fromt),e.item.rooms[o].pivot.tot=new Date("1970-01-01T"+e.item.rooms[o].pivot.tot),i=Object.assign(i,e.item.rooms[o].pivot),e.selectedRooms.push(i);for(var s=0;s<e.rooms.length;s++)e.item.rooms[o].id===e.rooms[s].id&&e.roomChecked(e.rooms[s]);e.item.rooms[o]=Object.assign(e.item.rooms[o],e.item.rooms[o].pivot)}for(var r=0;r<e.courses.ps.length;r++)e.courses.ps[r].id===e.item.ps.id&&e.selectCourse(e.courses.ps[r])}):(e.selectedPeriod={},e.selectedRooms=[],e.selectedCourse={},e.currentPage=0,e.book=[],e.item={rooms:[],date_index:"",guests:[],ps:[]})},e.roomChecked=function(t){if(t.checked=!t.checked,t.checked)e.selectedRooms.push(t),t.fromt||(t.fromt=new Date("1970-01-01T07:58:00"),t.tot=new Date("1970-01-01T07:59:00"));else{for(var o=e.selectedRooms.length-1;o>=0;o--)e.selectedRooms[o].id===t.id&&e.selectedRooms.splice(o,1);e.item.rooms=[]}},e.selectCourse=function(e){e.selected=!e.selected},e.fromAnotherPage=!0,e.createFormControllerNotV=!1,e.selectAllCourse=function(){e.coursesDp.map(function(e){e.selected=!0})},e.deselectAllCourse=function(){e.coursesDp.map(function(e){e.selected=!1}),e.item.ps=[]},e.selectAllRoom=function(){e.roomDP.map(function(t){if(!e.room||""===e.room)return void(t.checked=!0);JSON.stringify(t).toLowerCase().indexOf(e.room.toLowerCase())>=0&&(t.checked=!0)})},e.deselectAllRoom=function(){e.rooms.map(function(e){e.checked=!1}),e.selectedRooms=[],e.item.rooms=[]},e.nextPage=function(){3===e.currentPage&&e.copyDefaultRoom(),5===e.currentPage&&e.getBook(e.item),e.currentPage++},e.prevPage=function(){3===e.currentPage&&e.copyDefaultRoom(),e.currentPage--},e.gotoPage=function(t,o){3===e.currentPage&&e.copyDefaultRoom(),o&&!o.active||(e.currentPage=t)},e.getBook=function(o){t.apiCall("POST","api/public/roombook/dates",function(t){e.book=t.data},void 0,o)},e.$watch("item.fromd",function(e,t,o){if(o.item&&o.item.fromd){var i=o.item.fromd.getDay();o.selectedDays[i].s||o.dayChecked(o.selectedDays[i])}}),e.$watch("selectedPeriod",function(e,t,o){if(e&&e.fromd&&(o.item.fromd=new Date(e.fromd),o.item.tod=new Date(e.tod),o.item.tod=new Date(o.item.tod.getTime()+864e5),o.item.period=e.id,o.dayState=!0,o.selectAllDays(),o.item&&o.item.fromd)){var i=o.item.fromd.getDay();o.selectedDays[i].s||o.dayChecked(o.selectedDays[i]),o.item.tod&&o.item.fromd>=o.item.tod&&(o.item.tod=new Date(o.item.fromd.getTime()+864e5))}}),e.$watch("item.tod",function(e,t,o){o.item&&o.item.tod&&o.item.fromd&&o.item.fromd>=o.item.tod&&(o.item.tod=new Date(o.item.fromd.getTime()+864e5))}),t.apiCall("GET","api/public/active/rooms",function(t){e.rooms=t.data,e.tileRooms=e.rooms,e.filterRooms(e.roomDP,e.tileRooms,e.roomsFilter)}),t.apiCall("GET","api/public/periods",function(t){e.periods=t.data}),t.apiCall("GET","api/public/users",function(t){t.data.map(function(t){e.allTeachers[t.id]=t})}),e.$watch("selectedConfig",function(t,o){t&&e.getCourses(t)}),e.getCourses=function(o){e.courses=[],e.tms=[],t.apiCall("GET","api/public/ps/conf/"+e.selectedConfig,function(t){e.courses=t.data}),t.apiCall("GET","api/public/tms",function(t){var o=[];t.data.map(function(e){o.indexOf(e.descr)<0&&o.push(e.descr)}),e.tms=o})},e.itemsrooms=[],e.itemtype=[],t.apiCall("GET","api/public/itemtype",function(t){e.itemsrooms=t.data,e.itemtype=t.data,e.itemtype.map(function(e){e.title=e.descr})}),e.init(),e.defaultCourseSelection=null,e.courseFilterObj={tm:null,km:null,ex:null,pm:null,gen:null,tma:null},e.filterCourses=function(t,o,i){e.coursesDp=[],o.map(function(t){var o=!0;o=!i.tm||t.tm_per==i.tm,o=!(i.psex&&!(i.psex.indexOf(t.ps_ex)>=0)||!o),o=!(i.pskm&&!(i.pskm.indexOf(t.ps_km)>=0)||!o),o=!(i.pm&&!(i.pm.indexOf(t.pm)>=0)||!o),(o=!(i.tma&&!(t.tma_code.indexOf(i.tma)>=0)||!o))&&e.coursesDp.push(t)})},e.roomsFilter={room:null,item:null,roomcat:null},e.filterRooms=function(t,o,i){for(;e.roomDP.length>0;)e.roomDP.pop();for(var s=0,r=0;r<e.itemtype.length;r++)e.itemtype[r].visible&&s++;o.map(function(t){for(var o=!1,i=0,r=0;r<t.items.length;r++){for(var a=0;a<e.itemtype.length;a++)t.items[r].id===e.itemtype[a].id&&e.itemtype[a].visible&&i++;i===s&&(o=!0)}!o&&s||e.roomDP.push(t)})},t.apiCall("GET","api/public/roomcategory",function(t){e.roomscategory=t.data}),e.filteringRooms=function(t,o,i){for(e.roomDP=[];e.roomDP.length>0;)e.roomDP.pop();o.map(function(t){var o=!0;o=!(!(!i.room||t.name.indexOf(i.room.toUpperCase())>=0||t.address.indexOf(i.room.toUpperCase())>=0)||!o),(o=!(i.roomcat&&t.capasity_categ!==i.roomcat||!o))&&e.roomDP.push(t)})},e.$watch("calendarSelectedDay",function(t){t&&e.copyDayRequest(t)}),e.postCopyDay=function(){t.apiCall("POST","api/public/requests/copyday",function(e){},void 0,e.reqToPush)},e.reqToPush=[]}]).directive("bookView",function(){return{restrict:"EA",templateUrl:"modules/bookview/bookView.html"}}).directive("reqUserNavigation",function(){return{restrict:"EA",templateUrl:"modules/bookview/reqUserNavigation.html"}}).directive("userHeader",function(){return{restrict:"EA",templateUrl:"modules/bookview/userHeader.html"}});