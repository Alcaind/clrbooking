"use strict";angular.module("MainComponents").controller("CalendarContol",["$scope","MakeModal","$compile","orderByFilter","$filter","api","$location",function(e,o,t,r,a,n,i){function s(e){if(e.new){e.fDay=new Date(e.fromd),e.tDay=new Date(e.tod),e.h=(e.tot-e.fromt)/6e4/3;var o=new Date(e.fromt);return o.setHours(0,0,0,0),e.dist=(Math.abs(e.fromt-o)/6e4-420)/3,e.fromt=new Date(e.fromt-o),e.fromt.setHours(e.fromt.getHours()+e.fromt.getTimezoneOffset()/60),e.tot=new Date(e.tot-o),e.tot.setHours(e.tot.getHours()+e.tot.getTimezoneOffset()/60),e.showTod=new Date(e.tDay)-new Date(e.fDay)>864e5,{fDay:new Date(e.fromd),tDay:new Date(e.tod)}}return e.fDay=new Date(e.fromd+"T"+e.pivot.fromt),e.tDay=new Date(e.tod+"T"+e.pivot.fromt),e.h=(new Date(e.fromd+"T"+e.pivot.tot)-e.fDay)/6e4/3,e.dist=(Math.abs(e.fDay-new Date(e.fromd+"T00:00:00"))/6e4-420)/3,e.showTod=new Date(e.tDay)-new Date(e.fDay)>864e5,{fDay:new Date(e.fromd+"T"+e.pivot.fromt),tDay:new Date(e.tod+"T"+e.pivot.fromt)}}function d(o,t){e.reqPerRoom[t.name]||(e.reqPerRoom[t.name]=[]),e.reqPerRoom[t.name].includes(o)||e.reqPerRoom[t.name].push(o)}function m(o,t){if(e.calendar=[],e.newCalendar=[],e.reqPerRoom={},e.bookingErrors=[],e.headerDays=[],e.requestsBookedFromHoliday=[],e.fromd&&e.tod&&e.datesIndex&&o&&t){e.calendar=[],e.headerDays=[];var r=new Date(e.fromd.getTime());r.setHours(0,0,0,0);var a=new Date(e.fromd.getTime());a.setHours(0,0,0,0);var n=new Date(e.tod);n.setHours(0,0,0,0);for(var i=Math.ceil(Math.abs(n.getTime()-r.getTime())/864e5),d=null,m=[],c=0;c<i;c++){var f={};if(e.datesIndex&&e.datesIndex.indexOf(a.getDay())>=0){e.headerDays.push(new Date(a)),d=e.calendar.push([]),e.item.new=!0,m=[];for(var p=0;p<e.rooms.length;p++)if(e.rooms[p].date_index===a.getDay()){e.rooms[p].new=!0,f=Object.assign({},e.rooms[p]),f.book=e.item,f.color="#75a575",e.item.fromd.setHours(0,0,0,0),f.fromd=e.item.fromd,e.item.tod.setHours(0,0,0,0),f.tod=e.item.tod,f.did="r"+c+p;var u=s(f);if(u&&u.fDay<=a&&u.tDay>=a){e.calendar[d-1].push(f);for(var w=0;w<m.length;w++)(f.tot>=m[w].fromt&&f.tot<=m[w].tot||f.fromt>=m[w].fromt&&f.fromt<=m[w].tot)&&m[w].id===f.id&&(f.color="#e4e123",m[w].color="#e4e153");m.push(f)}}for(var D=0;D<o.length;D++)if(o[D].showTod=new Date(o[D].tod+" 00:00:00")-new Date(o[D].fromd+" 00:00:00")>864e5,!(e.item.id&&o[D].id===e.item.id||[2,4,3].includes(o[D].status))){if(new Date(o[D].fromd+" 00:00:00")<=a&&new Date(o[D].tod+" 00:00:00")>=a)for(var h=0;h<o[D].rooms.length;h++)if(1*o[D].rooms[h].pivot.date_index===a.getDay())for(0===e.rooms.length&&l(o[D].rooms[h],o[D],e.calendar[d-1],m),p=0;p<e.rooms.length;p++)1*e.rooms[p].date_index===a.getDay()&&o[D].rooms[h].id===e.rooms[p].id&&l(o[D].rooms[h],o[D],e.calendar[d-1],m);"13"!==o[D].class_use||e.holidayBook.includes(o[D])||e.holidayBook.push(o[D])}e.newCalendar[d-1]||(e.newCalendar[d-1]={}),e.calendar[d-1].map(function(o){e.newCalendar[d-1][o.name]||(e.newCalendar[d-1][o.name]=[]),e.newCalendar[d-1][o.name].push(o)})}a.setDate(a.getDate()+1)}}}function l(o,t,r,a){d(t,o),o.fromd=t.fromd,o.tod=t.tod,s(o);var n=Object.assign({},o);n.book=t,n.fromBookError=[],n.color="#287ed2";for(var i=new Date("1970-01-01T"+n.pivot.tot),m=new Date("1970-01-01T"+n.pivot.fromt),l=!1,c=0;c<a.length;c++)a[c].fromt.setSeconds(0),a[c].tot.setSeconds(0),m.setSeconds(30),(i>a[c].fromt&&i<a[c].tot||m>a[c].fromt&&m<a[c].tot||i<a[c].tot&&m>a[c].tot||m<a[c].fromt&&i>a[c].fromt)&&a[c].id===o.id?(l=!0,n.color="#287ed2",a[c].color="#e4aba8",n.fromBookError.push(a[c]),n.did="b"+c+a[c].did,e.bookingErrors.push(n)):n.color=l?"#287ed2":5===t.status?"#d29a46":0===t.status?"#DC4600":"#287ed2";for(var f=0;f<r.length;f++)r[f].book.priorityFlag=!1,r[f].pivot&&(i>new Date("1970-01-01T"+r[f].pivot.fromt)&&i<new Date("1970-01-01T"+r[f].pivot.tot)||m>new Date("1970-01-01T"+r[f].pivot.fromt)&&m<new Date("1970-01-01T"+r[f].pivot.tot)||i<new Date("1970-01-01T"+r[f].pivot.tot)&&m>new Date("1970-01-01T"+r[f].pivot.tot)||m<new Date("1970-01-01T"+r[f].pivot.fromt)&&i>new Date("1970-01-01T"+r[f].pivot.fromt))&&r[f].id===n.id&&r[f].book.priority&&n.book.priority>r[f].book.priority&&(r[f].color="#2bff05",r[f].book.priorityFlag=!0,e.requestsBookedFromHoliday.push(r[f]));r.push(n)}function c(e){var o=window.open("","_blank","location=yes,height=570,width=800,scrollbars=yes,status=1");return o.document.write(e),o.document.close(),o}e.calendar=[],e.weekdays=["Δ","Τρ","Τετ","Πεμ","Παρ","Σ","Κ"],e.errorWeekdays=["Δευτέρα","Τρίτη","Τετάρτη","Πέμπτη","Παρασκευή","Σάββατο","Κυριακή"],e.headerDays=[],e.hours=[],e.options={weekday:"short",year:"numeric",month:"short",day:"numeric"},e.showErrors=!!e.showErrors&&e.showErrors,e.programView=!1,e.newCalendar=[],e.reqPerRoom={},e.holidayBook=[],e.classUses=[],e.commentsVisible=!1,e.$watch("book",m),e.commentsVisibillity=function(){e.commentsVisible=!e.commentsVisible},e.popup=function(t){if(!t.new){o.infoBookRoom(t.pivot.id,function(o){o=JSON.parse(o),1===o.type&&(t.book.ps=o.data,t.book.ps_id=o.data.id),3===o.type&&(e.mustRefresh=!0),0===o.type&&(t.book.status=1,t.color="#287ed2",t.book.ps_id=o.data.id,t.book.ps=o.data)})}},e.selectDay=function(o){e.selectedDay=o},n.apiCall("GET","api/public/roomuse",function(o){o.data.map(function(o){e.classUses[o.id]=o})}),e.calendarFilterObj={tm:null},e.filterBookByTm=function(o){return!e.calendarFilterObj.tm||o.book.tm&&o.book.tm.descr===e.calendarFilterObj.tm||o.new},e.filterReportTm=function(o){return!e.calendarFilterObj.tm||o.tm&&o.tm.descr===e.calendarFilterObj.tm},e.filterReport2Tm=function(o){return"13"!==o.class_use&&(!e.calendarFilterObj.tm||o.tm&&o.tm.descr===e.calendarFilterObj.tm)},e.periods&&0!==e.periods.length||n.apiCall("GET","api/public/periods",function(o){e.periods=[],o.data.map(function(o){e.periods[o.id]=o})}),e.expFile=function(e){c(!1===e?document.getElementById("report2").innerHTML:document.getElementById("report").innerHTML)},function(){for(var o=7;o<24;o++)e.hours[o-7]={ht:o+":00",booked:!1,i:o}}()}]).directive("calendarBook",function(){return{restrict:"EA",scope:{fromd:"=",tod:"=",datesIndex:"=",book:"=",item:"<",rooms:"<",bookingErrors:"=",selectedDay:"=",showErrors:"<",mustRefresh:"=",tms:"=",comingFromBookController:"<",teachers:"=",periods:"="},controller:"CalendarContol",templateUrl:"modules/mainComponents/views/calendar/calendar.html"}}).directive("arrowError",function(){return{restrict:"EA",scope:{from:"=",to:"="},templateUrl:"modules/mainComponents/views/arrowError.html",link:function(e,o,t){var r=angular.element(document.getElementById(t.from)),a=angular.element(document.getElementById(t.to)),n=r.position(),i=a.position(),s=Math.atan2(i.top-n.top,n.left-i.left);s*=180/Math.PI;var d={"background-color":"red",position:"absolute",top:i.top+"px",left:i.left+"px",width:n.left-i.left+"px",transform:"rotate("+s+"deg)"};o.css(d)}}}).directive("reportErrors",function(){return{restrict:"EA",templateUrl:"modules/mainComponents/views/calendar/reportErrors.html"}}).directive("reportCalendar",function(){return{restrict:"EA",templateUrl:"modules/mainComponents/views/calendar/reportCalendar.html"}}).directive("reportCanceled",function(){return{restrict:"EA",templateUrl:"modules/mainComponents/views/calendar/reportCanceled.html"}}).directive("reportCanceledLessons",function(){return{restrict:"EA",templateUrl:"modules/mainComponents/views/calendar/reportCanceledLessons.html"}});